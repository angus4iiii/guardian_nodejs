name: Guardian Unit Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: frankfurtdb
          MYSQL_USER: skynet3_user
          MYSQL_PASSWORD: 8d256f61-9329-46d2-bbb4-ecebe28dd617
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      mysql-skynet:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: skynet3
          MYSQL_USER: skynet3_user
          MYSQL_PASSWORD: 8d256f61-9329-46d2-bbb4-ecebe28dd617
        ports:
          - 3307:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install root dependencies
      run: npm install

    - name: Install backend dependencies
      run: |
        cd backend
        npm install || echo "No backend package.json found, using root dependencies"

    - name: Install frontend dependencies
      run: |
        cd frontend
        npm install

    - name: Setup test database credentials
      run: |
        # Update database host for CI environment
        sed -i 's/"host":"localhost"/"host":"127.0.0.1"/g' backend/db-creds-test.json
        sed -i 's/"port": 3306/"port": 3306/g' backend/db-creds-test.json
        
        # Create skynet database credentials for second MySQL instance
        cp backend/db-creds-test-skynet.json backend/db-creds-test-skynet-ci.json
        sed -i 's/"host":"localhost"/"host":"127.0.0.1"/g' backend/db-creds-test-skynet-ci.json
        sed -i 's/"port": 3306/"port": 3307/g' backend/db-creds-test-skynet-ci.json

    - name: Wait for MySQL services
      run: |
        echo "Waiting for MySQL services to be ready..."
        sleep 30
        
        # Test frankfurtdb connection
        mysql -h 127.0.0.1 -P 3306 -u skynet3_user -p8d256f61-9329-46d2-bbb4-ecebe28dd617 -e "SELECT 1;" frankfurtdb
        
        # Test skynet3 connection  
        mysql -h 127.0.0.1 -P 3307 -u skynet3_user -p8d256f61-9329-46d2-bbb4-ecebe28dd617 -e "SELECT 1;" skynet3

    - name: Setup test database schema
      run: |
        # Create required tables for testing (add your actual schema here)
        mysql -h 127.0.0.1 -P 3306 -u skynet3_user -p8d256f61-9329-46d2-bbb4-ecebe28dd617 frankfurtdb << EOF
        CREATE TABLE IF NOT EXISTS devicecalibrationrunresults (
          id INT AUTO_INCREMENT PRIMARY KEY,
          crankserialnumber VARCHAR(255),
          resultcode INT,
          variationmetric DECIMAL(10,2),
          datecreated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS devicepressuretestvalues (
          id INT AUTO_INCREMENT PRIMARY KEY,
          crankserialnumber VARCHAR(255),
          resultcode INT,
          datecreated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS devicecalibrationcrankinfo (
          calid INT,
          crankserialnumber VARCHAR(255)
        );
        
        CREATE TABLE IF NOT EXISTS devicecalibrationng (
          calid INT,
          serialnumber VARCHAR(255)
        );
        
        CREATE TABLE IF NOT EXISTS devicepodoqcdata (
          id INT AUTO_INCREMENT PRIMARY KEY,
          serialnumber VARCHAR(255),
          resultcode INT,
          datecreated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        
        CREATE TABLE IF NOT EXISTS devicetemperaturerunresults (
          id INT AUTO_INCREMENT PRIMARY KEY,
          crankserialnumber VARCHAR(255),
          resultcode INT,
          datecreated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        EOF

        mysql -h 127.0.0.1 -P 3307 -u skynet3_user -p8d256f61-9329-46d2-bbb4-ecebe28dd617 skynet3 << EOF
        CREATE TABLE IF NOT EXISTS crank_progress_events (
          id INT AUTO_INCREMENT PRIMARY KEY,
          productionsn VARCHAR(255),
          event TEXT,
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
        EOF

    - name: Start backend server
      run: |
        cd backend
        node index.js &
        echo $! > backend.pid
        sleep 5
      env:
        NODE_ENV: test

    - name: Run Guardian Unit Tests
      run: |
        node debug-test.js
      timeout-minutes: 5

    - name: Run Frontend Tests
      run: |
        cd frontend
        npm test -- --coverage --watchAll=false

    - name: Stop backend server
      if: always()
      run: |
        if [ -f backend/backend.pid ]; then
          kill $(cat backend/backend.pid) || true
          rm backend/backend.pid
        fi

    - name: Upload test coverage
      uses: codecov/codecov-action@v3
      if: matrix.node-version == '20.x'
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage